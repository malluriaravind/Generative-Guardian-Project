# Generative Guardian Project

A Dockerized stack that includes:
- **Control Panel** (FastAPI + Uvicorn, serves API and built web UI)
- **Aggregator** (uWSGI Python service)
- **MongoDB** and **mongo-express** for data and admin
- **Nginx** as reverse proxy serving the SPA and proxying API/services

### Quick start (Docker Compose)

Prerequisites:
- Docker Engine and Docker Compose plugin installed
- Open ports: 80 (nginx), 8000 (control panel), 7007 (aggregator), 27018 (mongo mapped to 27017)

1) Clone and enter the repo
```bash
git clone <this-repo-url>
cd Generative-Guardian-Project
```

2) (Optional) Install Docker + Compose automatically
```bash
bash install.sh
```
This will also generate `default.conf` from `80-default.conf` and a `docker-compose.yml` with prompts. Otherwise, use the provided `docker-compose.yml`.

3) Start the stack
```bash
docker compose up -d --build
```

4) Access
- Web UI (served by nginx): http://localhost/
- API (proxied at): http://localhost/api
- Provider API (aggregator): http://localhost/provider/
- Mongo Express: http://localhost:8081

### Services overview

- `control_panel` (FastAPI):
  - Built web assets from `control_panel/web` are copied into the API image during build (`npm run rawbuild`).
  - Entrypoint: `control_panel/api/docker-entrypoint.sh` copies static files then runs Uvicorn.
  - Exposed at port 8000 internally. Proxied by nginx at `/api`.

- `aggregator` (uWSGI):
  - uWSGI config at `aggregator/uwsgi.ini` with module `server:app` and mule `alert_watchdog.py`.
  - Exposed at port 7007 internally. Proxied by nginx at `/provider/` and `/provider/generic/`.

- `mongodb` and `mongo-express`:
  - MongoDB exposed as 27018->27017 on host for local tools.

- `nginx`:
  - Uses `default.conf` to serve SPA at `/` from the built control panel dist and to proxy `/api` and `/provider/`.

### Configuration (environment variables)

These are set in `docker-compose.yml` and/or generated by `install.sh`.

- `control_panel`:
  - `JWT_SECRET`: random secret for auth tokens
  - `DATABASE_URL`: e.g. `mongodb://root:password@mongodb:27017`
  - `DATABASE_NAME`: e.g. `trussed`
  - `ENVIRONMENT`: typically `docker`
  - `ROOT_USER_EMAIL`, `ROOT_USER_PASSWORD`: bootstraps an admin account

- `aggregator`:
  - `DOMAIN`: public domain or IP used by the service
  - `MONGODB_URL`: same as above
  - `MONGODB_NAME`: e.g. `trussed`
  - `SMTP_FROM`, `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASSWORD`: email settings

### Build details

- Control image: `control.Dockerfile`
  - Stage 1 builds web UI with Node 18 and copies `dist` to API image under `/app/control_panel/api/temp/static/`
  - Python 3.12 runtime installs via Poetry; app launched via `uvicorn`

- Aggregator image: `agg.Dockerfile`
  - Python 3.12 runtime installs via Poetry
  - Launches: `poetry run uwsgi uwsgi.ini --socket :7007`

### Development mode

You can use `docker-compose.dev.yml` for a development layout (https only if you add certs):
```bash
docker compose -f docker-compose.dev.yml up -d --build
```
Notes:
- Mounts and ports differ; it also maps TLS certs if present (`nginx.crt`/`nginx.key`).
- To use the prebuilt aggregator image in dev, it points at `adankar/trussed_ai_dp:latest`. Adjust as needed.

### Logs and data

- Logs are mapped to files in `./logs/` for `control_panel` and `aggregator`.
- MongoDB data persisted in volume `mongodb-data`.
- Control panel static build output persisted in volume `control_panel_dist` and mounted by nginx.

### Nginx routing

`default.conf`:
```nginx
server {
  listen 80;
  location / { root /var/www/trussed/dist; try_files $uri $uri/ /index.html; }
  location /api { proxy_pass http://control_panel:8000; }
  location /provider/ { proxy_pass http://aggregator:7007/; }
  location /provider/generic/ { proxy_pass http://aggregator:7007/generic/; }
}
```

### Common tasks

- Rebuild everything after code changes:
```bash
docker compose build --no-cache && docker compose up -d
```

- Tail logs:
```bash
docker compose logs -f control_panel aggregator nginx mongodb
```

- Stop and remove:
```bash
docker compose down
```

### Troubleshooting

- Blank UI or 404 at `/`: ensure control panel web assets were built and nginx volume `control_panel_dist` is mounted. Rebuild `control_panel` image.
- 502/504 on `/api` or `/provider/`: check the container logs and that services are healthy.
- Mongo auth errors: verify `DATABASE_URL` credentials and that `mongodb` is reachable from containers.
- Email delivery issues: verify SMTP creds and that outbound SMTP is allowed.

### Manual local runs (advanced)

- Aggregator directly with Poetry:
```bash
cd aggregator
poetry install
poetry run uwsgi uwsgi.ini
```

- Control panel API directly:
```bash
cd control_panel/api
poetry install
poetry run uvicorn control_panel:app --host 0.0.0.0 --port 8000 --proxy-headers --log-config log.yaml
```

### License

See `authors.txt` for authors. License TBD.